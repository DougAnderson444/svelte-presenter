<script>
	import { tick } from 'svelte'
	import { tweened } from 'svelte/motion'
	import { fly } from 'svelte/transition'
	import { Carousel } from 'renderless-svelte'
	import Navigation from './components/Navigation.svelte'
	import color from './action/color'

	export let pages = []
	export let title = ""

	let current = tweened(0, { duration: 500 })
	$: currentIndex = Math.floor($current)

	let innerHeight
	let direction = 1
	let main

	const changePage = async idx => {
		direction = idx > currentIndex ? 1 : -1
		await tick()
		current.set(idx, {
			duration: Math.abs(idx - currentIndex) > 1 ? 500 : 0
		})
	}

	const handleKey = ({ key }) => {
		switch(key) {
			case 'ArrowUp': currentIndex !== 0 && changePage(currentIndex-1); return;
			case 'ArrowDown': currentIndex !== pages.length - 1 && changePage(currentIndex+1); return; 
		}
	}

	const handleScroll = ({ deltaY }) => {
		if (main.clientHeight >= main.scrollHeight) return
		main.scrollTo({
            top: deltaY,
            behaviour: 'smooth'
        })
    }
</script>

<svelte:window bind:innerHeight="" on:keyup={handleKey} on:mousewheel={handleScroll}></svelte:window>
<svelte:head>
	<title>{title}</title>
</svelte:head>

<Carousel items={pages} {currentIndex} let:payload>
	<Navigation {pages} setIndex={idx => changePage(idx)} {currentIndex} />
	<main>
		{#key payload}
			<div use:color={payload}
				bind:this={main}
				in:fly={{ y: direction*innerHeight, duration: 1000 }} 
				out:fly={{ y: direction*(0-innerHeight), duration: 1000 }}>	
				<svelte:component this={payload.component}></svelte:component>
			</div>
		{/key}
	</main>
</Carousel>

<style>
	main {
		display: flex;
		flex: 1;
		position: relative;
	}
	div {
        background-color: hsla(var(--hue), var(--sat), var(--lum), 50%);
        border: 2px solid hsl(var(--hue), var(--sat), var(--lum));
        border-radius: .5em;
		height: 100%;
		overflow: hidden;
		padding: .5rem;
		position: absolute;
		width: 100%;
	}
</style>